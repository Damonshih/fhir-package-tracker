<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚ç‰©æµå³æ™‚è¿½è¹¤ç³»çµ±</title>
    <!-- å¼•å…¥ Bootstrap ç¾åŒ–ä»‹é¢ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 800px; margin-top: 50px; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .header-title { color: #2c3e50; font-weight: bold; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .timeline { position: relative; padding: 20px 0; list-style: none; display: flex; justify-content: space-between; }
        .timeline-item { position: relative; width: 25%; text-align: center; }
        .timeline-item::before {
            content: ''; position: absolute; top: 15px; left: -50%; width: 100%; height: 4px; background: #e9ecef; z-index: 0;
        }
        .timeline-item:first-child::before { display: none; }
        
        .circle {
            width: 30px; height: 30px; border-radius: 50%; background: #e9ecef; border: 4px solid #fff;
            position: relative; z-index: 1; margin: 0 auto 10px; transition: all 0.3s;
        }
        .timeline-item.active .circle { background: #0d6efd; box-shadow: 0 0 0 4px #b6d4fe; }
        .timeline-item.active::before { background: #0d6efd; }
        
        .status-text { font-size: 0.9rem; color: #6c757d; font-weight: 500; }
        .timeline-item.active .status-text { color: #0d6efd; font-weight: bold; }

        #result-area { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-5">
        <h1 class="header-title">ğŸ¥ é†«ç™‚ç‰©æµå³æ™‚è¿½è¹¤ç³»çµ±</h1>
        <p class="text-muted">åŸºæ–¼ FHIR æ¨™æº–èˆ‡ Arduino IoT æŠ€è¡“</p>
    </div>

    <div class="card p-4">
        <div class="mb-3">
            <label for="package-id" class="form-label">è«‹è¼¸å…¥åŒ…è£¹ç·¨è™Ÿ (SupplyDelivery ID)</label>
            <div class="input-group">
                <input type="text" class="form-control" id="package-id" placeholder="ä¾‹å¦‚: PKG-12345" value="PKG-TEST-001">
                <button class="btn btn-primary" type="button" onclick="fetchData()">ğŸ” æŸ¥è©¢é€²åº¦</button>
            </div>
            <div class="form-text">è¼¸å…¥æ‚¨æƒæçš„ QR Code ç·¨è™Ÿä¾†æŸ¥çœ‹æœ€æ–°ç‹€æ…‹ã€‚</div>
        </div>
    </div>

    <!-- çµæœé¡¯ç¤ºå€ -->
    <div id="result-area" class="card p-4 mt-4">
        <h4 class="mb-4 text-center">ğŸ“¦ åŒ…è£¹ç‹€æ…‹è¿½è¹¤</h4>
        
        <!-- æ™‚é–“è»¸é€²åº¦æ¢ -->
        <div class="timeline-container">
            <ul class="timeline">
                <li class="timeline-item" id="step-1">
                    <div class="circle"></div>
                    <div class="status-text">ç™¼è²¨ä¸­å¿ƒ<br><small>(Warehouse)</small></div>
                </li>
                <li class="timeline-item" id="step-2">
                    <div class="circle"></div>
                    <div class="status-text">A é‹è¼¸ç«™<br><small>(Station A)</small></div>
                </li>
                <li class="timeline-item" id="step-3">
                    <div class="circle"></div>
                    <div class="status-text">B é‹è¼¸ç«™<br><small>(Station B)</small></div>
                </li>
                <li class="timeline-item" id="step-4">
                    <div class="circle"></div>
                    <div class="status-text">é†«é™¢è—¥å±€<br><small>(Pharmacy)</small></div>
                </li>
            </ul>
        </div>

        <div class="alert alert-info mt-3">
            <strong>ç›®å‰ç‹€æ…‹ï¼š</strong> <span id="current-status-text">ç­‰å¾…æŸ¥è©¢...</span>
            <br>
            <strong>æœ€å¾Œæ›´æ–°åœ°é»ï¼š</strong> <span id="current-location-text">-</span>
        </div>
        
        <!-- é¡¯ç¤ºåŸå§‹è³‡æ–™æŒ‰éˆ• (çµ¦è©•å¯©çœ‹è­‰æ˜ç”¨) -->
        <div class="text-end">
             <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rawData">
                é¡¯ç¤º FHIR åŸå§‹ JSON
            </button>
        </div>
        <div class="collapse mt-2" id="rawData">
            <div class="card card-body bg-light">
                <pre id="json-display" style="font-size: 0.8rem;"></pre>
            </div>
        </div>
    </div>
</div>

<!-- å¼•å…¥ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // é€™è£¡æ¨¡æ“¬å¾ Server æŠ“åˆ°çš„è³‡æ–™é‚è¼¯
    // åœ¨çœŸå¯¦ç’°å¢ƒä¸­ï¼ŒArduino æœƒä¸Šå‚³ä¸€å€‹ "scanCount" æˆ–è€…æ˜¯ "location" çš„æ¬„ä½åˆ° FHIR Server
    // å‰ç«¯è®€å–é€™å€‹æ¬„ä½ä¾†æ±ºå®šé€²åº¦æ¢è·‘åˆ°å“ªè£¡
    
    async function fetchData() {
        const packageId = document.getElementById('package-id').value;
        const resultArea = document.getElementById('result-area');
        const statusText = document.getElementById('current-status-text');
        const locationText = document.getElementById('current-location-text');
        const jsonDisplay = document.getElementById('json-display');
        
        // é¡¯ç¤ºè¼‰å…¥ä¸­
        statusText.innerText = "æŸ¥è©¢ä¸­...";
        resultArea.style.display = 'block';
        resetTimeline();

        try {
            // çœŸæ­£çš„ FHIR æŸ¥è©¢ URL (è«‹ç¢ºèªæ‚¨çš„ FHIR Server ç¶²å€)
            const fhirUrl = `https://hapi.fhir.org/baseR4/SupplyDelivery?identifier=${packageId}&_sort=-_lastUpdated&_count=1`;
            
            const response = await fetch(fhirUrl, {
                headers: { 'Accept': 'application/fhir+json' }
            });
            
            if (!response.ok) throw new Error("ç¶²è·¯é€£ç·šéŒ¯èª¤");
            
            const data = await response.json();
            
            if (data.total === 0 || !data.entry) {
                statusText.innerText = "æŸ¥ç„¡æ­¤åŒ…è£¹è³‡æ–™";
                locationText.innerText = "-";
                jsonDisplay.innerText = JSON.stringify(data, null, 2);
                return;
            }

            // å–å¾—æœ€æ–°çš„ä¸€ç­†è³‡æ–™
            const resource = data.entry[0].resource;
            jsonDisplay.innerText = JSON.stringify(resource, null, 2);

            // ---------------------------------------------------------
            // é—œéµé‚è¼¯ï¼šé€™è£¡åˆ¤æ–· Arduino ä¸Šå‚³çš„å…§å®¹ä¾†æ±ºå®šé€²åº¦
            // å‡è¨­ Arduino ä¸Šå‚³æ™‚æœƒåœ¨ extension æˆ– location è£¡æ¨™è¨»åœ°é»
            // æˆ–è€…æ˜¯æˆ‘å€‘ç”¨ resource.status ä¾†åˆ¤æ–·
            // ç‚ºäº† Demo æ–¹ä¾¿ï¼Œæˆ‘é€™è£¡å¯«ä¸€å€‹ç°¡å–®çš„åˆ¤æ–·é‚è¼¯ï¼Œæ‚¨å¯ä»¥è®“ Arduino æ”¹è®Š "suppliedItem" çš„åœ°é»åç¨±
            // ---------------------------------------------------------

            let currentLocation = "æœªçŸ¥";
            let progressStep = 0;

            // å˜—è©¦è®€å–åœ°é»è³‡è¨Š (å‡è¨­ Arduino å­˜åœ¨ occurrenceString æˆ–é¡ä¼¼æ¬„ä½ï¼Œæˆ–è€…æˆ‘å€‘çœ‹ extension)
            // *æ³¨æ„*ï¼šé€™è£¡éœ€è¦è·Ÿæ‚¨çš„ Arduino ç¨‹å¼ç¢¼é…åˆï¼Œçœ‹æ‚¨æŠŠåœ°é»å­—ä¸²å­˜åœ¨å“ª
            // å‡è¨­æ‚¨æŠŠåœ°é»æ”¾åœ¨ resource.occurrenceString æˆ–æ˜¯ resource.location (åƒè€ƒç”¨)
            
            // é€™è£¡ç‚ºäº†è®“æ‚¨ç¾å ´å¥½ Demoï¼Œæˆ‘å…ˆå¯«ä¸€å€‹æ¨¡æ“¬é‚è¼¯ï¼š
            // å¦‚æœ Arduino æœ‰å‚³é€ "location" æ“´å……æ¬„ä½ï¼Œå°±ç”¨é‚£å€‹ã€‚
            // å¦‚æœæ²’æœ‰ï¼Œæˆ‘å€‘è®€å– ID çš„å¾Œç¶´ä¾†æ¨¡æ“¬ (åƒ…ä¾›æ¸¬è©¦ç”¨ï¼Œæ­£å¼è«‹æ”¹ç”¨è®€å–çœŸå¯¦æ¬„ä½)
            
            // -------- æ­£å¼é‚è¼¯å»ºè­°ï¼šè«‹ Arduino æŠŠåœ°é»å¯«åœ¨ resource.suppliedItem.itemReference.display --------
            if (resource.suppliedItem && resource.suppliedItem.itemReference && resource.suppliedItem.itemReference.display) {
                 currentLocation = resource.suppliedItem.itemReference.display;
            }
            
            // æ ¹æ“šåœ°é»æ–‡å­—æ±ºå®šé€²åº¦ (é€™æ˜¯å°æ‡‰æ‚¨è¦æ±‚çš„ 4 å€‹éšæ®µ)
            if (currentLocation.includes("Warehouse") || currentLocation.includes("ç™¼è²¨")) {
                progressStep = 1;
                statusText.innerText = "åŒ…è£¹æº–å‚™ä¸­";
                statusText.className = "text-primary fw-bold";
            } else if (currentLocation.includes("Station A") || currentLocation.includes("Aç«™")) {
                progressStep = 2;
                statusText.innerText = "é‹é€ä¸­ - æŠµé” A è½‰é‹ç«™";
                statusText.className = "text-warning fw-bold";
            } else if (currentLocation.includes("Station B") || currentLocation.includes("Bç«™")) {
                progressStep = 3;
                statusText.innerText = "é‹é€ä¸­ - æŠµé” B è½‰é‹ç«™";
                statusText.className = "text-info fw-bold";
            } else if (currentLocation.includes("Pharmacy") || currentLocation.includes("è—¥å±€")) {
                progressStep = 4;
                statusText.innerText = "å·²é€é” - é†«é™¢è—¥å±€ç°½æ”¶";
                statusText.className = "text-success fw-bold";
            } else {
                // é è¨­ç‹€æ³ (å¦‚æœ Arduino è¿˜æ²¡ä¸Šä¼ åœ°ç‚¹)
                progressStep = 1; 
                statusText.innerText = "å·²å»ºç«‹è¨‚å–® (è³‡æ–™è§£æä¸­: " + currentLocation + ")";
            }

            locationText.innerText = currentLocation;
            updateTimeline(progressStep);

        } catch (error) {
            console.error(error);
            statusText.innerText = "è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– ID";
        }
    }

    function resetTimeline() {
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`step-${i}`).classList.remove('active');
        }
    }

    function updateTimeline(step) {
        for (let i = 1; i <= step; i++) {
            document.getElementById(`step-${i}`).classList.add('active');
        }
    }
</script>

</body>
</html>
