<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚åŒ…è£¹è¿½è¹¤ç³»çµ± (FHIR)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; }
        .container { background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.3s; }
        .btn-search { background-color: #3498db; color: white; }
        .btn-search:hover { background-color: #2980b9; }
        .btn-upload { background-color: #27ae60; color: white; }
        .btn-upload:hover { background-color: #219150; }
        #result-area { margin-top: 20px; }
        .log-item { background: #ecf0f1; padding: 15px; margin-bottom: 10px; border-left: 5px solid #3498db; border-radius: 4px; }
        .log-time { color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px; }
        .log-status { font-weight: bold; color: #2c3e50; }
        .loading { text-align: center; color: #7f8c8d; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“¦ é†«ç™‚åŒ…è£¹è¿½è¹¤ç³»çµ±</h1>
    <p style="text-align: center; color: #666;">é€£æ¥ HAPI FHIR Public Server</p>

    <!-- æŸ¥è©¢å€å¡Š -->
    <div class="input-group">
        <input type="text" id="trackId" placeholder="è«‹è¼¸å…¥åŒ…è£¹ç·¨è™Ÿ (ä¾‹å¦‚: PKG-8888)" value="PKG-8888">
        <button class="btn-search" onclick="searchPackage()">ğŸ” æŸ¥è©¢åŒ…è£¹ç·¨è™Ÿ</button>
    </div>

    <!-- æ¨¡æ“¬ Arduino ä¸Šå‚³å€å¡Š (æ–¹ä¾¿ä½ æ¸¬è©¦ç”¨) -->
    <div style="text-align: right; margin-bottom: 20px;">
        <button class="btn-upload" onclick="simulateArduinoUpload()">ğŸ“¤ æ¨¡æ“¬ Arduino ä¸Šå‚³ä¸€ç­†è³‡æ–™</button>
    </div>

    <div id="loading" class="loading">è³‡æ–™è®€å–ä¸­...</div>
    <div id="result-area"></div>
</div>

<script>
    // è¨­å®š FHIR Server ç¶²å€
    const FHIR_BASE_URL = "https://hapi.fhir.org/baseR4";

    // 1. æŸ¥è©¢åŠŸèƒ½ (GET)
    async function searchPackage() {
        const id = document.getElementById('trackId').value;
        if(!id) return alert("è«‹è¼¸å…¥åŒ…è£¹ç·¨è™Ÿï¼");

        document.getElementById('loading').style.display = 'block';
        document.getElementById('result-area').innerHTML = '';

        try {
            // å‘ FHIR Server æŸ¥è©¢ identifier ç­‰æ–¼è¼¸å…¥ç·¨è™Ÿçš„ SupplyDelivery è³‡æº
            const response = await fetch(`${FHIR_BASE_URL}/SupplyDelivery?identifier=${id}&_sort=-_lastUpdated`);
            const data = await response.json();

            document.getElementById('loading').style.display = 'none';

            if (!data.entry || data.entry.length === 0) {
                document.getElementById('result-area').innerHTML = '<p style="text-align:center">æŸ¥ç„¡æ­¤åŒ…è£¹è³‡æ–™ï¼Œè«‹å…ˆæ¨¡æ“¬ä¸Šå‚³ã€‚</p>';
                return;
            }

            // é¡¯ç¤ºæ¯ä¸€ç­†ç‰©æµç´€éŒ„
            data.entry.forEach(item => {
                const resource = item.resource;
                // ä¿®æ”¹å¾Œçš„ç¨‹å¼ç¢¼ï¼šå„ªå…ˆè®€å– occurrenceDateTimeï¼Œå¦‚æœæ²’æœ‰ï¼Œå°±è®€å– meta.lastUpdated (ä¼ºæœå™¨æ”¶åˆ°çš„æ™‚é–“)
                let displayTime = "æ™‚é–“æœªç´€éŒ„";
                if (resource.occurrenceDateTime) 
                {
                    displayTime = new Date(resource.occurrenceDateTime).toLocaleString();
                } 
                else if (resource.meta && resource.meta.lastUpdated) 
                {
                    displayTime = new Date(resource.meta.lastUpdated).toLocaleString() + " (æ¥æ”¶æ™‚é–“)";
                }

                const time = displayTime;
                const location = resource.destination ? resource.destination.display : "æœªçŸ¥åœ°é»";
                const status = resource.status || "æœªçŸ¥ç‹€æ…‹";

                const html = `
                    <div class="log-item">
                        <div class="log-time">${time}</div>
                        <div class="log-status">ğŸ“ åœ°é»ï¼š${location}</div>
                        <div>ç‹€æ…‹ï¼š${status}</div>
                        <div style="font-size:0.8em; color:#999;">Resource ID: ${resource.id}</div>
                    </div>
                `;
                document.getElementById('result-area').innerHTML += html;
            });

        } catch (error) {
            console.error(error);
            alert("æŸ¥è©¢å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Console");
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 2. æ¨¡æ“¬ä¸Šå‚³åŠŸèƒ½ (POST) - é€™æ®µé‚è¼¯ä¹‹å¾Œè¦å¯«åœ¨ Arduino è£¡
    async function simulateArduinoUpload() {
        const id = document.getElementById('trackId').value;
        const now = new Date().toISOString(); // å–å¾—ç¾åœ¨æ™‚é–“

        // å»ºç«‹ç¬¦åˆ FHIR æ¨™æº–çš„ JSON è³‡æ–™
        const fhirData = {
            "resourceType": "SupplyDelivery",
            "status": "completed",
            "identifier": [
                {
                    "system": "http://my-hospital.org/tracking-id",
                    "value": id
                }
            ],
            "occurrenceDateTime": now,
            "destination": {
                "display": "Arduino Station (Web Test)"
            }
        };

        try {
            const response = await fetch(`${FHIR_BASE_URL}/SupplyDelivery`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json+fhir"
                },
                body: JSON.stringify(fhirData)
            });

            if(response.ok) {
                alert(`âœ… æˆåŠŸä¸Šå‚³ä¸€ç­† ${id} çš„ç´€éŒ„ï¼\nç¾åœ¨è«‹é»æ“Šã€ŒæŸ¥è©¢åŒ…è£¹ç·¨è™Ÿã€ä¾†æŸ¥çœ‹ã€‚`);
                searchPackage(); // ä¸Šå‚³å®Œè‡ªå‹•é‡æ•´
            } else {
                alert("ä¸Šå‚³å¤±æ•—");
            }
        } catch (error) {
            console.error(error);
            alert("ä¸Šå‚³ç™¼ç”ŸéŒ¯èª¤");
        }
    }
</script>

</body>
</html>
